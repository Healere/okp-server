import{p as O,b as V,F as J,P as Y,G as Z,H as ee,J as te}from"./index.3082d1cd.js";import{d as Q,a as le,ab as oe,b as G,aj as W,N as ne,a8 as se,a9 as ie,f as _,F as re,a7 as K,k as ae,z as ce}from"./index.b57f2f57.js";const de=`.${O}-preview > [data-line]`,j=(e,l)=>+getComputedStyle(e).getPropertyValue(l).replace("px",""),he=(e,l)=>{const C=ee(()=>{e.removeEventListener("scroll",s),e.addEventListener("scroll",s),l.removeEventListener("scroll",s),l.addEventListener("scroll",s)},50),s=i=>{const h=e.clientHeight,b=l.clientHeight,d=e.scrollHeight,a=l.scrollHeight,f=(d-h)/(a-b);i.target===e?(l.removeEventListener("scroll",s),l.scrollTo({top:e.scrollTop/f}),C()):(e.removeEventListener("scroll",s),e.scrollTo({top:l.scrollTop*f}),C())};return[()=>{C().finally(()=>{e.dispatchEvent(new Event("scroll"))})},()=>{e.removeEventListener("scroll",s),l.removeEventListener("scroll",s)}]},pe=(e,l,C)=>{const{view:s}=C,i=te(),h=t=>s.lineBlockAt(s.state.doc.line(t+1).from).top,b=t=>s.lineBlockAt(s.state.doc.line(t+1).from).bottom;let d=[],a=[],f=[];const A=()=>{d=[],a=Array.from(l.querySelectorAll(de)),f=a.map(c=>Number(c.dataset.line));const t=[...f],{lines:n}=s.state.doc;let r=t.shift()||0,o=t.shift()||n;for(let c=0;c<n;c++)c===o&&(r=c,o=t.shift()||n),d.push({start:r,end:o-1})},L=(t,n)=>{let r=1;for(let o=a.length-1;o-1>=0;o--){const c=a[o],u=a[o-1];if(c.offsetTop+c.offsetHeight>n&&u.offsetTop<n){r=Number(u.dataset.line);break}}for(let o=d.length-1;o>=0;o--){const c=b(d[o].end),u=h(d[o].start);if(c>t&&u<=t){r=r<d[o].start?r:d[o].start;break}}return r};let p=0,N=0;const U=()=>{var t,n,r;if(N!==0)return!1;p++;const{scrollDOM:o,contentHeight:c}=s;let u=j(l,"padding-top");const T=s.lineBlockAtHeight(o.scrollTop),{number:g}=s.state.doc.lineAt(T.from),k=d[g-1];if(!k)return!1;let B=1;const P=l.querySelector(`[data-line="${k.start}"]`)||((t=l.firstElementChild)==null?void 0:t.firstElementChild),v=l.querySelector(`[data-line="${k.end+1}"]`)||((n=l.lastElementChild)==null?void 0:n.lastElementChild),H=o.scrollHeight-o.clientHeight,S=l.scrollHeight-l.clientHeight;let y=h(k.start),$=b(k.end),F=P.offsetTop,M=v.offsetTop-F;y===0&&(F=0,P===v?(u=0,$=c-o.offsetHeight,M=S):M=v.offsetTop),B=(o.scrollTop-y)/($-y);const q=v==((r=l.lastElementChild)==null?void 0:r.lastElementChild)?v.offsetTop+v.clientHeight:v.offsetTop;if($>=H||q>S){const R=L(H,S);y=h(R),B=(o.scrollTop-y)/(H-y);const I=l.querySelector(`[data-line="${R}"]`);y>0&&I&&(F=I.offsetTop),M=S-F+j(l,"padding-top")}const D=F-u+M*B;i(l,D,()=>{p--})},x=()=>{var t,n,r,o,c,u;if(p!==0)return;N++;const{scrollDOM:T}=s,g=l.scrollTop,k=l.scrollHeight,B=T.scrollHeight-T.clientHeight,P=l.scrollHeight-l.clientHeight;let v=(t=l.firstElementChild)==null?void 0:t.firstElementChild,H=(n=l.firstElementChild)==null?void 0:n.lastElementChild;if(f.length>0){let I=Math.ceil(f[f.length-1]*(g/k)),m=f.findLastIndex(E=>E<=I);m=m===-1?0:m,I=f[m];for(let E=m;E>=0&&E<f.length;)if(a[E].offsetTop>g){if(E-1>=0){E--;continue}I=-1,m=E;break}else{if(E+1<f.length&&a[E+1].offsetTop<g){E++;continue}I=f[E],m=E;break}switch(m){case-1:{v=(r=l.firstElementChild)==null?void 0:r.firstElementChild,H=a[m];break}case f.length-1:{v=a[m],H=(o=l.firstElementChild)==null?void 0:o.lastElementChild;break}default:v=a[m],H=a[m+1===a.length?m:m+1]}}let S=v===((c=l.firstElementChild)==null?void 0:c.firstElementChild)?0:v.offsetTop-j(v,"margin-top"),y=H.offsetTop,$=0;const{start:F,end:M}=d[Number(v.dataset.line||0)];let q=h(F);const D=h(M+1===s.state.doc.lines?M:M+1);let R=0;if(D>B||H.offsetTop+H.offsetHeight>P){const I=L(B,P),m=l.querySelector(`[data-line="${I}"]`);S=m?m.offsetTop-j(m,"margin-top"):S,q=h(I),$=(g-S)/(P-S),R=B-q}else v===((u=l.firstElementChild)==null?void 0:u.firstElementChild)?(v===H&&(y=H.offsetTop+H.offsetHeight+ +getComputedStyle(H).marginBottom.replace("px","")),R=D,$=Math.max(g/y,0)):($=Math.max((g-S)/(y-S),0),R=D-q);i(e,q+R*$,()=>{N--})},w=t=>{var n;const{scrollDOM:r,contentHeight:o}=s,c=r.clientHeight;if(o<=c||l.firstElementChild.clientHeight<=l.clientHeight||s.state.doc.lines<=((n=d[d.length-1])==null?void 0:n.end))return!1;t.target===e?U():x()};return[()=>{A(),e.addEventListener("scroll",w),l.addEventListener("scroll",w),e.dispatchEvent(new Event("scroll"))},()=>{e.removeEventListener("scroll",w),l.removeEventListener("scroll",w)}]},fe={tocItem:{type:Object,default:()=>({})},mdHeadingId:{type:Function,default:()=>{}},onActive:{type:Function,default:()=>{}},onClick:{type:Function,default:()=>{}},scrollElementOffsetTop:{type:Number,default:0}},X=Q({props:fe,setup(e){const l=K("scrollElementRef"),C=K("roorNodeRef"),s=G();return ae(()=>e.tocItem.active,i=>{i&&(s.value?e.onActive(e.tocItem,s.value):ce(()=>{e.onActive(e.tocItem,s.value)}))},{immediate:!0}),()=>{const{tocItem:i,mdHeadingId:h,onClick:b,scrollElementOffsetTop:d}=e;return _("div",{ref:s,class:[`${O}-catalog-link`,i.active&&`${O}-catalog-active`],onClick:a=>{b(a,i),a.stopPropagation();const f=h(i.text,i.level,i.index),A=C.value.getElementById(f),L=l.value;if(A&&L){let p=A.offsetParent,N=A.offsetTop;if(L.contains(p))for(;p&&L!=p;)N+=p==null?void 0:p.offsetTop,p=p==null?void 0:p.offsetParent;const U=A.previousElementSibling;let x=0;U||(x=j(A,"margin-top")),L==null||L.scrollTo({top:N-d-x,behavior:"smooth"})}}},[_("span",{title:i.text},[i.text]),i.children&&i.children.length>0&&_("div",{class:`${O}-catalog-wrapper`},[i.children.map(a=>_(X,{mdHeadingId:h,key:`${i.text}-link-${a.level}-${a.text}`,tocItem:a,onActive:e.onActive,onClick:b,scrollElementOffsetTop:d},null))])])}}}),ue={editorId:{type:String,default:void 0},class:{type:String,default:""},mdHeadingId:{type:Function,default:e=>e},scrollElement:{type:[String,Object],default:void 0},theme:{type:String,default:"light"},offsetTop:{type:Number,default:20},scrollElementOffsetTop:{type:Number,default:0},onClick:{type:Function,default:void 0},onActive:{type:Function,default:void 0},isScrollElementInShadow:{type:Boolean,default:!1}},z=Q({name:"MdCatalog",props:ue,emits:["onClick","onActive"],setup(e,l){const C=e.editorId,s=`#${C}-preview-wrapper`,i=le({list:[],show:!1,scrollElement:e.scrollElement||s}),h=oe(),b=G(),d=G(),a=G(),f=G(),A=G({});W("scrollElementRef",d),W("roorNodeRef",f);const L=ne(()=>{const t=[];return i.list.forEach((n,r)=>{const{text:o,level:c}=n,u={level:c,text:o,index:r+1,active:h.value===n};if(t.length===0)t.push(u);else{let T=t[t.length-1];if(u.level>T.level)for(let g=T.level+1;g<=6;g++){const{children:k}=T;if(!k){T.children=[u];break}if(T=k[k.length-1],u.level<=T.level){k.push(u);break}}else t.push(u)}}),t}),p=()=>{var t;if(i.scrollElement instanceof HTMLElement)return i.scrollElement;let n=document;return(i.scrollElement===s||e.isScrollElementInShadow)&&(n=(t=b.value)==null?void 0:t.getRootNode()),n.querySelector(i.scrollElement)},N=t=>{if(t.length===0)return i.list=[],!1;const{activeHead:n}=t.reduce((r,o,c)=>{var u;const T=(u=f.value)==null?void 0:u.getElementById(e.mdHeadingId(o.text,o.level,c+1));if(T instanceof HTMLElement){const g=Z(T,d.value);if(g<e.offsetTop&&g>r.minTop)return{activeHead:o,minTop:g}}return r},{activeHead:t[0],minTop:Number.MIN_SAFE_INTEGER});h.value=n,i.list=t},U=(t,n)=>{A.value.top=n.offsetTop+j(n,"padding-top")+"px",e.onActive?e.onActive(t,n):l.emit("onActive",t,n)},x=()=>{N(i.list)},w=t=>{var n,r;const o=p();d.value=o,a.value=o===document.documentElement?document:o,(n=a.value)==null||n.removeEventListener("scroll",x),N(t),(r=a.value)==null||r.addEventListener("scroll",x)};return se(()=>{f.value=b.value.getRootNode(),V.on(C,{name:J,callback:w}),V.emit(C,Y)}),ie(()=>{var t;V.remove(C,J,w),(t=a.value)==null||t.removeEventListener("scroll",x)}),()=>_("div",{class:[`${O}-catalog`,e.theme==="dark"&&`${O}-catalog-dark`,e.class||""],ref:b},[L.value.length>0&&_(re,null,[_("div",{class:`${O}-catalog-indicator`,style:A.value},null),_("div",{class:`${O}-catalog-container`},[L.value.map(t=>_(X,{mdHeadingId:e.mdHeadingId,tocItem:t,key:`link-${t.level}-${t.text}`,onActive:U,onClick:(n,r)=>{e.onClick?e.onClick(n,r):l.emit("onClick",n,r)},scrollElementOffsetTop:e.scrollElementOffsetTop},null))])])])}});z.install=e=>(e.component(z.name,z),e);export{z as M,he as a,pe as s};
